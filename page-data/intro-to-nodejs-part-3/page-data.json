{"componentChunkName":"component---src-templates-blog-post-js","path":"/intro-to-nodejs-part-3/","webpackCompilationHash":"e7a09ab67e530e789081","result":{"data":{"site":{"siteMetadata":{"title":"tech-blog","author":"Alamgir Qazi"}},"markdownRemark":{"id":"af742493-b425-5608-ad3a-03c28ba69cd7","excerpt":"This is the part 3 of post Intro to Nodejs - part 2. In this post, we will look at improving our existing code and add new features like…","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f570d/node-js.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB6ElEQVQoz32ST0sbURTF37xUlyq4iYotFilvJkqCmHkUyfyLSi2lLhS0Gy2lioi68QuYMaZoxbroF5B2UREXhX4G0cTWUHWjErMRim7cdTme+5IganDgcOfNnPnNu/cdxh65bMdUNWHF6Z47rlTrSq160UtS8lXJtLBjsPSBzvysrtaWE3/gdz3JegdKP0vtGWwpr7OFXcFWTyPKwNXfPcnJsPhb56ms4Iv7Ojc7XlYgDdA0FII0+EO2I3kQMJb+o2vkAVR7sNv3S9E769cj3cq0Mr9M0EuAwtW6BKyW6upZhJMxCf1yk9Kjh35OT2CX31BdWru9Mk7vCeh4Zh12Fk/0yG3U/nJHBkZkQxG0XE/A/9AP25b/xlOxcPpAXK2ddwSo15Pr0WbLkgWMY8NxzQvcPwe0+HasO4dvdqa+Rhszh2IQbX8AcC7z16gjYPHNO7MGwPzwTNfTdF4UvhQ7CXgxsRYL25Y8gWcLKgDYXAZuJvtl08/g2RPskGAfoVkAGwj4grbu9ZntjA3xT8dCwPQZpxwttxyD5zskS1GSnWh5HbVVjWjPaMEMe6C227xZ1XM17sfunJxlmdr9CFXLoTLhULRG5rLMkdD8nAj5+6UYIHMqJhSvih/zDFVgftbQMEPKrhYEo+wGOwusfLZj/14AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Intro To Node.js\"\n        title=\"\"\n        src=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/b9e4f/node-js.png\"\n        srcset=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/cf440/node-js.png 148w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/d2d38/node-js.png 295w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/b9e4f/node-js.png 590w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f9b6a/node-js.png 885w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f570d/node-js.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>This is the part 3 of post <a href=\"https://alamgirqazi.github.io/tech-blog/intro-to-nodejs-part-2/\">Intro to Nodejs - part 2</a>.</p>\n<p>In this post, we will look at improving our existing code and add new features like password hashing. We will also take a look at JWT tokens.</p>\n<p>First we define a User model.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const Users = mongoose.model(&#39;Users&#39;, {\n    name: String,\n    email: String,\n    password: String,\n    date_added: Date\n   });</code></pre></div>\n<p>Right. Now we first set up login / Signup.</p>\n<p>We will make some changes in the Signup method we wrote in previous tutorial. Remember, we never save passwords as string in database. They are always hashed.</p>\n<p>We need to encrypt passwords. Node.js provides us a module for that, Bcrypt. Brcypt causes dependency issues so instead, we will use <code class=\"language-text\">bcryptjs</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install bcryptjs</code></pre></div>\n<p>btw I would recommend installing <a href=\"https://yarnpkg.com/lang/en/\">yarn</a> and running <code class=\"language-text\">yarn add bcryptjs</code> instead.</p>\n<p>Lets get back to our code.</p>\n<p>we first include bcrypt at the top</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const bcrypt = require(&#39;bcryptjs&#39;);</code></pre></div>\n<p>now modifying our /signup method</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> app.post(&#39;/signup&#39;, async (req, res) =&gt; {\n\n  try{\n    const body = req.body;\n\n    // there must be a password in body\n\n    // we follow these 2 steps\n\n    const password = body.password;\n\n    var salt = bcrypt.genSaltSync(10);\n    var hash = bcrypt.hashSync(password, salt);\n\n    console.log(&#39;hash - &gt; &#39;, hash);\n    // const user = new Users(body);\n\n\n    // const result = await user.save();\n\n    // res.send({\n    //   message: &#39;Student signup successful&#39;\n    // });\n\n  }\n\n  catch(ex){\n    console.log(&#39;ex&#39;,ex)\n\n    res.send({\n      message: &#39;Error&#39;,\n      detail: ex\n    }).status(500);\n  }\n\n  });</code></pre></div>\n<p>A couple of things to notice.</p>\n<ol>\n<li>I wrapped the code in try/catch. Always use it when you are using <code class=\"language-text\">await</code> in the code.</li>\n<li>we are using bcrypt to hash the password.</li>\n</ol>\n<p>let try it in Postman and see what we get in console.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/76d12/testsignup1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.527847049044055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAAB2ElEQVQoz42Q22oTURSG90sJxkMsiK/gU0jTNESlps00SZtABemFb+CNBwq1Iki91ydQ6I2EYFsnmcOew57z/K61pyNj8cIFH3sd/732FqezRzh8foDRZIrtHQNDY0yMsNl7jM7GJgbPBuj3n6BLcbfXR6fbwwaxTrXhzi5e0Mx6p4etgYGnW9sQZ4c38OXlAxzt38fR5B5OZms4nq7h3egOXg9b+DS9jZPJLYqJXaaFt0YLb4ybON5r4+P4Lt5PqO+gjQ+zNkQWWyjVJRCcA7lTkVkVuUunXfnwiYAIgdJDHlwg83+ijJfUR/V0qXXEypIwVy5sx4O5tPGLfEcGcD0mhMu+vPI9Bekr2DKE5zr4/D3Aw1chxqcBLJvmqC6kdOF7kvBoUMI6X8BZLREEPjzKh2EIpRSiKCLUFRGSWOHSifD1h8K3C8op6vMlRJpliOMIKRHFMaIwQEwDaZrqwTzPUZblX3COobf/oSwolyYQpmkiSRJUVqK2oij0dnw2xdhivpgu0+JFRZFEyGhrsVgs9DZc5OFagM/6qf8S1dc3N6eYtxbz+Ry+7+uhpnETb9IUuC503bSg/mB6MgcZ/SdT+5xvxrXPL2Lqv2z2aEEu1gNNmkL/y2/r1B+fdV39XQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"signup using postman\"\n        title=\"\"\n        src=\"/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/b9e4f/testsignup1.png\"\n        srcset=\"/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/cf440/testsignup1.png 148w,\n/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/d2d38/testsignup1.png 295w,\n/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/b9e4f/testsignup1.png 590w,\n/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/f9b6a/testsignup1.png 885w,\n/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/2d849/testsignup1.png 1180w,\n/tech-blog/static/9ff9af508b79073fab772f4323fc76f1/76d12/testsignup1.png 1203w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Here’s what we get in our Node.js console</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/16854049296bcc15ff6c1163c97cb748/64b01/hash.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.36241610738255%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAABg0lEQVQoz6WR3S/DUBjGz9svNVNMq91Y6zNYEX+GW4m/AYn4iGwTibDaEOHWDQlbZJsEMeP/e5xuzaxGduHil+d533P6vD3nsN2tdRTv7lF+qKBSrDYol6qolp5QKz+jXnnGB+cz0HrAe4MX1Divj09443Xx5hYsaSdguxOYWJ6CveBgfImzyOHe4eq4TWa5n5/jpBykAubmm+q6Nqamk5hMOmAjsV7YjgxtkEGSGRj7J8OmiviMiFhchj4qI6or6NO5xhREVAWSIILaPiBGHKEDxvuSIIHpMRORqAZjxIJlJWBaFgzDgGlaGE2MwdANaP0ahgYGGvSqaiv4+8+aXiIRrEdUf0xnLfyeQMQRIAb4NYUCqeVFP1AiJTSlGxQaTKHh/kCmCMofR6AuwdQZ6N+lRPL/XzYU6L9M+wL9sjnoEQW+VYdP4d81W1tdwWE2De8oh3Mvj3zuFAXOWS6PS6+A69NCw19xveD1pa8nHo6zhygcedjP7GAvk8bJQRabG9v4AvC0LPixAUbqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"has\"\n        title=\"\"\n        src=\"/tech-blog/static/16854049296bcc15ff6c1163c97cb748/b9e4f/hash.png\"\n        srcset=\"/tech-blog/static/16854049296bcc15ff6c1163c97cb748/cf440/hash.png 148w,\n/tech-blog/static/16854049296bcc15ff6c1163c97cb748/d2d38/hash.png 295w,\n/tech-blog/static/16854049296bcc15ff6c1163c97cb748/b9e4f/hash.png 590w,\n/tech-blog/static/16854049296bcc15ff6c1163c97cb748/f9b6a/hash.png 885w,\n/tech-blog/static/16854049296bcc15ff6c1163c97cb748/64b01/hash.png 1043w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>So this means, we will save $2a$10$GTxdgZ.KNxiGud.rvNM9SOfOTXuWKp/963ZlN6L9IR1ydSn8TclTy in database instead of 123456 which gives us more security. Even if our database is hacked, the user wont have direct access to passwords. He only can see the hash.</p>\n<p>We still need to do some work in password. we need to replace the old password with new hash.</p>\n<p>Just one line added</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  const salt = bcrypt.genSaltSync(10);\n  const hash = bcrypt.hashSync(password, salt);\n\n  body.password = hash;</code></pre></div>\n<p>new updated code</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> app.post(&#39;/signup&#39;, async (req, res) =&gt; {\n\n  try{\n    const body = req.body;\n\n    // there must be a password in body\n\n    // we follow these 2 steps\n\n    const password = body.password;\n\n    var salt = bcrypt.genSaltSync(10);\n    var hash = bcrypt.hashSync(password, salt);\n\n    body.password = hash;\n    console.log(&#39;hash - &gt; &#39;, hash);\n    const user = new Users(body);\n\n\n    const result = await user.save();\n\n    res.send({\n      message: &#39;Student signup successful&#39;\n    });\n\n  }\n\n  catch(ex){\n    console.log(&#39;ex&#39;,ex)\n\n    res.send({\n      message: &#39;Error&#39;,\n      detail: ex\n    }).status(500);\n  }\n\n  });</code></pre></div>\n<p>Lets take a look at the database</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/850690ed04dcb5a7126644af2f288582/9910f/hashsaved.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.81395348837209%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABJ0AAASdAHeZh94AAABpUlEQVQoz6WTW2vbQBCF9f9f+hdaQkILeQoNlJJSS1bltJjYFByKvbp55bUdyyLGknXX6ezKdgRtHkoHPnbmsJydvWm6oeNx8ogJwWYMvufDcz2F67iv4kjsFpvZ8P05el91aOOfEwjB8bTZIHqOsI0i7OMYcZwgy3MUZanIiyPHukuWF5DBmANtOByB8wBVVdHKDJ8/3cLofSHuYBk9DPo6LGJgGrgnBqautC5Wvwfrm4Gb62tos+kUG+quzFM82Ctc9ae4Gfq4HXF8fOB4P3BxSdqFaeOdwWh0cGl5Zy5MF1cmw1vS33ygLYuFUN1laYokK7DYPGOXlkgr4EDsKJn5Aq4IMV9HENs9wn2Op12KbZwjLkF1hoy2/ItxaItggaIocDgcUJUFmopmNDVeokEttZrcQXpTtXl90nAe557XGpZ0sNJQGrcWRNMc6Vr/GXJOXbcNuM5rhh2XF+O/oxo8G7rQOOfKKEkS5PRMTiv+C/IOZNg2PZv1aq0K2eX/Bp/TpYxHYwRBoH6I7FaIJSEUS8pXxPJINz/NkchjC8MQ3+9/4Dd9ojlNTkLpGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"hash saved\"\n        title=\"\"\n        src=\"/tech-blog/static/850690ed04dcb5a7126644af2f288582/b9e4f/hashsaved.png\"\n        srcset=\"/tech-blog/static/850690ed04dcb5a7126644af2f288582/cf440/hashsaved.png 148w,\n/tech-blog/static/850690ed04dcb5a7126644af2f288582/d2d38/hashsaved.png 295w,\n/tech-blog/static/850690ed04dcb5a7126644af2f288582/b9e4f/hashsaved.png 590w,\n/tech-blog/static/850690ed04dcb5a7126644af2f288582/f9b6a/hashsaved.png 885w,\n/tech-blog/static/850690ed04dcb5a7126644af2f288582/2d849/hashsaved.png 1180w,\n/tech-blog/static/850690ed04dcb5a7126644af2f288582/9910f/hashsaved.png 1505w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>That looks awesome. Exactly what we wanted.</p>\n<p>There’s one problem. What if user logins with email bilal@gmail.com and password: 123456, how are we going to check ? we don’t have 123456 saved but instead, the hash.</p>\n<p>Lets see how we will modify our login method</p>\n<p>Here’s what we’re doing now</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">app.post(&#39;/login&#39;, async (req, res) =&gt; {\n  try {\n    const body = req.body;\n\n    const email = body.email;\n\n    // lets check if email exists\n\n    const result = await Users.findOne({ email: email });\n    if (!result) {\n      // this means result is null\n      res.status(401).send({\n        Error: &#39;This user doesnot exists. Please signup first&#39;\n      });\n    } else {\n      // email did exist\n      // so lets match password\n\n      if (body.password === result.password) {\n        // great, allow this user access\n\n        console.log(&#39;match&#39;);\n\n        res.send({ message: &#39;Successfully Logged in&#39; });\n      } else {\n        console.log(&#39;password doesnot match&#39;);\n\n        res.status(401).send({ message: &#39;Wrong email or Password&#39; });\n      }\n    }\n  } catch (ex) {\n    console.log(&#39;ex&#39;, ex);\n  }\n});</code></pre></div>\n<p>Lets try it</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/67bc9/testlogin.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 64.82982171799027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABJ0AAASdAHeZh94AAACd0lEQVQ4y62Sy09TQRSH79/jRsVoYiI+lv4NRlnIAozGxIWKCSujmLAwQU14CfgoTwFBE4Ou1YURo4JQSiu05SFpaXvfz36euaXxEZdO8uU3Z+7vnDlzZ7TE/S5mxicZTEwz8GhcmGDw8QR9AyN09z0VHaX34Qi9/cMxPf0JuhV9CQaGxkgID3qe0Dc4yt2ufrSxln3MtJ+k48ppbrY2cvviCe5cOkX7+SNcPbOfztaj3Gw+TFvTIW40NXDt7AGuK8410HHhOPdaGmV+kM7LJ2lvPoaW/zgM+Vnc1CTu6jR+5jleego/PY2j4tVJwswU4dos0foLqtmXBN9nqHwbw1qS3NyE5E9SXXvG9ochtLXsDqYHhiNYAWVR0xWcKiUzFCJMO8LywQ7ACcUnfscN+ZCDttcwtQASkt0ooaWSSfRKiYpQKBQo/NikVNjBMCoYehlTqRCrXkMXHGOXz1mdW28qvPxSxjNLrGfSaLlsDt/3cSwTy7Ixy7sYpSKO42DbNoF8i6LoD6rVKpEA0W/Adj6Pll7N4Pke1dgcxkZlVUmWZeF53q8ie6o2UyivH0Z4gZw39NhSBec/zstxK7E5HqpgvLv8R9OMu6zHda0Xro/6fHtrS468nosX1LF9P8CX3YJAaRBrGIYxwV4cf1M+8bvSveUGckF+3G0+vymX8vUTllHGkG4MQ5ebNuUCdFxLl0J7Rf8mrGm9oO2q4j653Aba4sIixZJOsahT2LUEm0LRolK2cLwQW3D+QbzuR7i+iqVLL6p1mE5n+F+jXK6gzb2aY3lpmaS8x+RykpU9Ve9zNblCarlGpj5P1lCeOio/lUrx7u17fgIBbKoAxHbakQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"test login\"\n        title=\"\"\n        src=\"/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/b9e4f/testlogin.png\"\n        srcset=\"/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/cf440/testlogin.png 148w,\n/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/d2d38/testlogin.png 295w,\n/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/b9e4f/testlogin.png 590w,\n/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/f9b6a/testlogin.png 885w,\n/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/2d849/testlogin.png 1180w,\n/tech-blog/static/34ae28dd35763168c1bf78ba850291c0/67bc9/testlogin.png 1234w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>It’s saying wrong email/password even though its right :/</p>\n<p>we make just 1 line change in our code. we compare it using bcrypt</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> if ( bcrypt.compareSync(body.password, result.password))</code></pre></div>\n<p>Now using wrong login</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/15333006e02ce66e47749daadebf3d75/30caf/wronglogin.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 64.89104116222761%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABJ0AAASdAHeZh94AAACdklEQVQ4y62SSU8VQRDH5+t4UjEaDxL06Hdw4YAJLjHGCy6JJhoTDNwMkU2eKIYHiDxFTPRiogQJB2EGeGDCIhJx4c3aM9Mz3TPzt6bfI8LBm538UlXdVdX/6Rqtt60Nr0dGURgYQ1//MDGCwpMRdPcNorNngGwR3Y8G0d37DF1EZ0+Vh0Tf4yEMFIro6Hqq8js6+6E9adqHidsNaL16EnfP16P1EvmXT+BW0xG0nNqPtgtHce/cYdxoPISbjXW4dvoArp8hztbh/sUGPGg+Rv5BtF85jjvN9dC+fCwAPyYQrbxAtFqCXH+FeHUMYq0EvvISgvx0vYRkYxzptwlkm28gv47DXRpGuFwENkeB72NI1p7DWShCK5fXEUjACzMwX8IJAZ/nZLD9hEjhh0QMhJTHE4CRz6MEUxtAy1ugtEhntLdtR9D0z7NgzIHr2KiYJiq/tmBVftOeB+Y58JmrfF/hKjzPBWcWZjc8tL938a5cjbd/bkFbLi8jSRNwnyEIQwSuDWabpCBCSLGUEmma7iHLMqQEkNYgn2LXMknhnLG3KFPHqigIAsRx/LdJzXLOFXlTkaQQkt5BcDh5w8kPk/R2DElCm1CdVFG+fN9XKnfirHaW7crZUZcv13XpkxeXVJArEUKq26SyUinPL5I1fwchBBHTs8TwI0lWqDrTsqHNfZpEmD80YwQNglTlQ+C+u6dZktTYdUlEIgKaNo8FQh7BNC1oM9MzsF0Gs+KhYgU0aU42pKkHlJjQ7/Bv8vNIVG1ASi3bgWYY8/hfS9Jna0ODw9B1nTCgz+kwlK9jgeJFfV7ZeWLJyP1qnFuDcvVdGLQ/PTWNP8p3qEYk0QbCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"wrong login\"\n        title=\"\"\n        src=\"/tech-blog/static/15333006e02ce66e47749daadebf3d75/b9e4f/wronglogin.png\"\n        srcset=\"/tech-blog/static/15333006e02ce66e47749daadebf3d75/cf440/wronglogin.png 148w,\n/tech-blog/static/15333006e02ce66e47749daadebf3d75/d2d38/wronglogin.png 295w,\n/tech-blog/static/15333006e02ce66e47749daadebf3d75/b9e4f/wronglogin.png 590w,\n/tech-blog/static/15333006e02ce66e47749daadebf3d75/f9b6a/wronglogin.png 885w,\n/tech-blog/static/15333006e02ce66e47749daadebf3d75/2d849/wronglogin.png 1180w,\n/tech-blog/static/15333006e02ce66e47749daadebf3d75/30caf/wronglogin.png 1239w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Now using correct login</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/99d00/correctlogin.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 65.06514657980456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABJ0AAASdAHeZh94AAACcUlEQVQ4y62SSU8UURRG6/+40JBojFFh629witHEYDDGjSKGFUYWkrgwRqARcGixmdElG0PUjSuiHUhX9QDYKE03PdQ89fFWFTgkxpWVnNx7X7533/fuK2V65AmLmVkm0wuMP5sWZph4PkNqfIrh1EuJrxl9OsXo2KuYkbE0wxGpNOOTGdLC45EXjE1kGHo4jLLQc4j5/i4Gb55hoPsU93s6GbzeRf/lY9w6e5gH3ccZuHKUOxc76BNunztC73nhQgeD107z6OpJemV96EYnfZdOoOx+zsDWInZuFkebxy0s4GpzwjyWKrU6S5CfIygtEW68Ed7iFxdpZqcw19KwOS37Z2iXZtn6mEL5VmmhO2AIuunTsJPcsELqRoJhtzE9sIME3QXLCfn0Fe4uw9wX8EIolHZQtjZKNBt7NJt1qtUqu9/L1KsVdL2J3moIzTg34jqhJdj6HqubLe4tN1labeBbDbT1dZRKpYLjujimgWlaGI0aRr2GbdtYloXneYRh+AftdptQgPA35ObFIsp2eVsaOiIScRDEwkgbbTRN82fDuMl+jA6LiLReEOJ6MofQY7NQQMlmszQa9VgYf3HDJDcMI3Z5UB/EpHHiKlnfd7ixGV15l0AEkRPP8/H8AN//FQNxHRHlCUGiE31UO66H7XhERxWLG/IouTUMGX7kpqW3MOSahtGSmerSKGkS/I0gibbjyou7cm2ffF5mqGka1b0mtVqL2p4pucVu1ZTXNLFlNrb7bxz5XyxXnPptCpHDcrnM//oqOxWUlXcr5HI5IqeaqiZoKgVVE/Lk46hR0vJxfYCmHug11Jwq8yvyfuUDPwBh1arTUs9HvAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"correct login\"\n        title=\"\"\n        src=\"/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/b9e4f/correctlogin.png\"\n        srcset=\"/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/cf440/correctlogin.png 148w,\n/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/d2d38/correctlogin.png 295w,\n/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/b9e4f/correctlogin.png 590w,\n/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/f9b6a/correctlogin.png 885w,\n/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/2d849/correctlogin.png 1180w,\n/tech-blog/static/46b9564ee3193f360acc1e163c1a630e/99d00/correctlogin.png 1228w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Hurray !!!</p>\n<p>Here is the complete code</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">app.post(&#39;/login&#39;, async (req, res) =&gt; {\n  try {\n    const body = req.body;\n\n    const email = body.email;\n\n    // lets check if email exists\n\n    const result = await Users.findOne({ email: email });\n    if (!result) {\n      // this means result is null\n      res.status(401).send({\n        Error: &#39;This user doesnot exists. Please signup first&#39;\n      });\n    } else {\n      // email did exist\n      // so lets match password\n\n      if ( bcrypt.compareSync(body.password, result.password)) {\n        // great, allow this user access\n\n        console.log(&#39;match&#39;);\n\n        res.send({ message: &#39;Successfully Logged in&#39; });\n      } else {\n        console.log(&#39;password doesnot match&#39;);\n\n        res.status(401).send({ message: &#39;Wrong email or Password&#39; });\n      }\n    }\n  } catch (ex) {\n    console.log(&#39;ex&#39;, ex);\n  }\n});</code></pre></div>\n<p>we learned how to use password hashing. We allowed user to sign in. There’s still one more thing we need to do. Once a user logs in, we need to provide it a <code class=\"language-text\">token</code>. That <code class=\"language-text\">token</code> will tell us which user it is. With that token, that user can make changes to our database but without that token, a user cannot make any changes to our database or access our secure apis. <code class=\"language-text\">Token</code> kindof works as a guards for us. remember Route Guards? the concept is very similar.</p>\n<p>We will use JWT Tokens.</p>\n<p>What we will do is whenever a user successfully logins, we will create a JWT token and send it back in response. This means whenever an Angular / Web App / Mobile app user successfully logins, he will get back a token in return. We will then save that token. For now, lets just see how to create it.</p>\n<p>What happens in real world apps is that every protected request send via HTTP includes some sort of token. that token tells the server / us where the request came from, who is the user etc. Lets see how we incorporate that.</p>\n<p>First, we need to add a JWT module for Express.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install jsonwebtoken\n\nor\n\nyarn add jsonwebtoken</code></pre></div>\n<p>include jsonwebtoken at the top</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const jsonwebtoken = require(&#39;jsonwebtoken&#39;);</code></pre></div>\n<p>Now lets create a JWT Token</p>\n<p>Lets update the /Login method</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">if ( bcrypt.compareSync(body.password, result.password)) {\n        // great, allow this user access\n\n        console.log(&#39;match&#39;);\n\n        const token = jsonwebtoken.sign({\n           data: body,\n           role: &#39;User&#39;\n        }, &#39;supersecretToken&#39;, { expiresIn: &#39;7d&#39; });\n\n        console.log(&#39;token -&gt; &#39;, token)\n\n        res.send({ message: &#39;Successfully Logged in&#39;, token: token });\n      }</code></pre></div>\n<p>what we’re doing here is using the <code class=\"language-text\">jsonwebtoken</code> module to sign some data. Note with body, we also send role. Here, we can handle multiple roles e.g admin, teacher etc. We manage rules using tokens as well.</p>\n<p>Lets try to login using postman and see if we get the token in console.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/4778933bba679d633d1f7d8770dd2085/b828e/correctloginwithtoken.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 71.0569105691057%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAACqElEQVQ4y3WSyU8UURCH+98xUSGaGKMc/Tc0GOPBIAeuKnpyvWhMNCaAKLuCChoXcIsXjypGCZBxmJ1lWKb37tfLZ3XPDBlMnOTLr1696ppXizbdd5/ZmZeMTr5maPQ5Q2MvGJmYYXB4kr7BcQaGp+h//JT+R08YEPofTdCXMDjB40b8g4ExBkeecffeQ7Sprn1M93Zws+cEV88d41a32Oc7uHLmMBdO7ud21xGunz1Eb2c7l0+3c/HUAeEglzrbuNF1nGtdHeJv405P8s1RtI2Fl7Dxkaj4jrg0B5X3orNQniMsyln8lOW89hHWP0nsZ1j9gPPnFUF2RnxvoCoxlbesfRtHK5Sq1OwY3Q6pGR5bZojhRBh2wJah2DZVapse2L6gQHfBcRVfczHdryLGvod4AazkNtBy2SymUcPQa2xubbG5vsr2ZhXTNMSvY4km2Jaxayd3nrXDr5LJnS8Gcws6gaOTXV5GW62soZTCd2wcx8XRd4RtPM+Xs0MQBMRxTBRFqTbtUIC4QWJLZ/IFtHwuj+/79aAwJEo+kJjkbNv27l2TJKHrunhCJIEqiPBVKB8oSrkc2vyPeWq1WnpZ/4nGdduyrPSVcePcqk271V8uleolR3GUlq1UIIR1lVKTcpNXBw27ST1WpbYrrXE9lVaVzxfRVhZ+YknfDHmNIUMwbUuaruPZRkuycA+Jv3mXJHQkoSePyK7k0TKZjEzQwjVNUQ/L8DF1DyUDiqO4pfH/g92hFIsylPn5n9Inj7WCz/JvyCzC8oLoEuQyMQXZtVIhppiv62o5ZrMaU91ooRqxsw3ZP2W0pcUllDzfk8WV9UK2R/5AFtgS7LqvlcQn7ZPpCw2Vqkm2qFSsoC1KQk+yBYEvffFTTWnYiW8P4lPqH3xPJh2RrOBfZvr+6J5vDXsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"correct login with token\"\n        title=\"\"\n        src=\"/tech-blog/static/4778933bba679d633d1f7d8770dd2085/b9e4f/correctloginwithtoken.png\"\n        srcset=\"/tech-blog/static/4778933bba679d633d1f7d8770dd2085/cf440/correctloginwithtoken.png 148w,\n/tech-blog/static/4778933bba679d633d1f7d8770dd2085/d2d38/correctloginwithtoken.png 295w,\n/tech-blog/static/4778933bba679d633d1f7d8770dd2085/b9e4f/correctloginwithtoken.png 590w,\n/tech-blog/static/4778933bba679d633d1f7d8770dd2085/f9b6a/correctloginwithtoken.png 885w,\n/tech-blog/static/4778933bba679d633d1f7d8770dd2085/2d849/correctloginwithtoken.png 1180w,\n/tech-blog/static/4778933bba679d633d1f7d8770dd2085/b828e/correctloginwithtoken.png 1230w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>You can see the token in the response.</p>\n<p>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7Il9pZCI6IjVkZTIxODhhY2U2Y2ZiMDQwYzMwM2I4ZCIsIm5hbWUiOiJCaWxhbCIsImVtYWlsIjoiYmlsYWxAZ21haWwuY29tIiwicGFzc3dvcmQiOiIkMmEkMTAkdWdtSHAwcFhYSTR1S2ZNVk45cm1PT1FPaENLWENPYS8xS0g0bnJ4VGtWekVRU2syM0pqRmUiLCJfX3YiOjB9LCJyb2xlIjoiVXNlciIsImlhdCI6MTU3NTEwMzg4MSwiZXhwIjoxNTc1NzA4NjgxfQ.C2C3iiiDl8N3SH8utZYbUwrqChH0NfyxzPbdUZQCyco</p>\n<p>Let open <a href=\"jwt.io\">jwt.io</a></p>\n<p>Lets copy and paste the token on the left hand side.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/7bc83/jwtio.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.98576122672508%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABJ0AAASdAHeZh94AAABnklEQVQoz3VR20ojQRCdLzCZmMgMiE+Chn1b9ssEYyaTiIoI/qPLosuymqjxknR6+lLH6q5M4gW7OVR11elTXdXJaDRCr9fD2fklLi4ucXJ6iqIYRAwGJcpyiHI4/GALjh8VBYqDAxz2+yhHx+hzfMhaSZq20GhsYH/vF7o/fqLb3UezmSJttdDpdJBlGfI8R7vdZl4DHbabmy2kqXDyLMfuzjayrS2+10TivQcR4eV5ivHdf6j5DM4YeGsZRnzmzDk+nkwwVwpVVcGGPMeDNQznXNRJUC/DuHfAhAXutOBWw40tUAUCgSoWMTZe/G4lIRm2VR7qmqBuBIt/wOJvAOfmBE8O7lWBFlUUJE9il6g7TaQYwfEl/ZsFrihCs7j+I76bAdZbaG0g5T0X8FHkPZYvFEGrCdNHj8dnwv3U44lt8B+eiGdGkeMVC/PZvnKRBS1bF9RjSMQQDLcwc6E2kyG2Rtz8AsNi5oExZdEZ57QIe1O3DvmUqF4Pmr5CZhTGAjgl1BV87X8SrAPvBy0fhtXQw4tCu+TWbRLW3LDeAKJSwJr2nBtdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"jwt io\"\n        title=\"\"\n        src=\"/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/b9e4f/jwtio.png\"\n        srcset=\"/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/cf440/jwtio.png 148w,\n/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/d2d38/jwtio.png 295w,\n/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/b9e4f/jwtio.png 590w,\n/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/f9b6a/jwtio.png 885w,\n/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/2d849/jwtio.png 1180w,\n/tech-blog/static/1cba1f1987fa6da632ef49ff6a9149f3/7bc83/jwtio.png 1826w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>When we decode it, we can see the data for e.g User Email, ID, Role etc. We also see password which should not be in that token. so we can remove it by</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  delete result[&#39;password&#39;];\n\n        const token = jsonwebtoken.sign({\n           data: result,\n           role: &#39;User&#39;\n        }, &#39;supersecretToken&#39;, { expiresIn: &#39;7d&#39; });</code></pre></div>\n<p>if delete doesn’t work</p>\n<p>then just do</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> result.password = undefined;</code></pre></div>\n<p>now the JWT token won’t have password. Btw, the token will expire after 7 days. the secret key with which we can <strong><em>validate</em></strong> the token is <code class=\"language-text\">supersecretToken</code>. Right now, we wrote this in code which is a bad practice. We will fix this in the next tutorial.</p>\n<p>So in this, we improved our Login/Register methods with better practices such as password hashing and usage of JWT Tokens.</p>\n<p>Here is the look at the final code <a href=\"https://github.com/alamgirqazi/simplest-nodejs-auth/tree/part3\">Link to code of part 3</a></p>\n<p>There are still some things we can improve in this workflow. First of all, one index.js with all the code is not a good approach at all. We need to split things up. 2. we wrote secret information such as database name, JWT token secret key inside code which is a BAD practice. we never write it in code. we define them in environment variables. In the next post, we will cover that.</p>","frontmatter":{"title":"A very basic introduction to Node.js - Part 3","date":"November 30, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/intro-to-nodejs-part-3/","previous":{"fields":{"slug":"/intro-to-nodejs-part-2/"},"frontmatter":{"title":"A very basic introduction to Node.js - Part 2"}},"next":{"fields":{"slug":"/intro-to-nodejs-part-4/"},"frontmatter":{"title":"A very basic introduction to Node.js - Part 4"}}}}}