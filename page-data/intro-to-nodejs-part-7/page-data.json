{"componentChunkName":"component---src-templates-blog-post-js","path":"/intro-to-nodejs-part-7/","webpackCompilationHash":"001b5052281d79efbc1f","result":{"data":{"site":{"siteMetadata":{"title":"tech-blog","author":"Alamgir Qazi"}},"markdownRemark":{"id":"beeae1be-3238-51c5-8954-68bc1fd82f43","excerpt":"This is the part 7 of post Intro to Nodejs - part 6. So lets get started. In the next part, we will cover Guards and Authentication. Only…","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f570d/node-js.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB6ElEQVQoz32ST0sbURTF37xUlyq4iYotFilvJkqCmHkUyfyLSi2lLhS0Gy2lioi68QuYMaZoxbroF5B2UREXhX4G0cTWUHWjErMRim7cdTme+5IganDgcOfNnPnNu/cdxh65bMdUNWHF6Z47rlTrSq160UtS8lXJtLBjsPSBzvysrtaWE3/gdz3JegdKP0vtGWwpr7OFXcFWTyPKwNXfPcnJsPhb56ms4Iv7Ojc7XlYgDdA0FII0+EO2I3kQMJb+o2vkAVR7sNv3S9E769cj3cq0Mr9M0EuAwtW6BKyW6upZhJMxCf1yk9Kjh35OT2CX31BdWru9Mk7vCeh4Zh12Fk/0yG3U/nJHBkZkQxG0XE/A/9AP25b/xlOxcPpAXK2ddwSo15Pr0WbLkgWMY8NxzQvcPwe0+HasO4dvdqa+Rhszh2IQbX8AcC7z16gjYPHNO7MGwPzwTNfTdF4UvhQ7CXgxsRYL25Y8gWcLKgDYXAZuJvtl08/g2RPskGAfoVkAGwj4grbu9ZntjA3xT8dCwPQZpxwttxyD5zskS1GSnWh5HbVVjWjPaMEMe6C227xZ1XM17sfunJxlmdr9CFXLoTLhULRG5rLMkdD8nAj5+6UYIHMqJhSvih/zDFVgftbQMEPKrhYEo+wGOwusfLZj/14AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Intro To Node.js\"\n        title=\"\"\n        src=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/b9e4f/node-js.png\"\n        srcset=\"/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/cf440/node-js.png 148w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/d2d38/node-js.png 295w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/b9e4f/node-js.png 590w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f9b6a/node-js.png 885w,\n/tech-blog/static/a717eafa290bf333c4dd1c86076c5b9e/f570d/node-js.png 960w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>This is the part 7 of post <a href=\"https://alamgirqazi.github.io/tech-blog/intro-to-nodejs-part-6/\">Intro to Nodejs - part 6</a>.</p>\n<p>So lets get started.</p>\n<p>In the next part, we will cover Guards and Authentication. Only the user who are logged in should see the books list and should only be able to add/edit/delete. We will discuss concepts like Authentication, Authorization, Guards and Interceptors.</p>\n<p>First, we need to protect our backend.</p>\n<p>Only authorized users should have access to Books List right. Only authorized users can add/update/delete books from the database.</p>\n<p>How do we do it?</p>\n<p>Remember, we created a JWT Token when we login? we will use that token and save in our “local Storage”.</p>\n<p>Once token is saved, every request is sent with an authorization header. That includes our credentials.</p>\n<p>Here is an example</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/c2216/authorization.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABJ0AAASdAHeZh94AAABo0lEQVQoz42Su24UMRSG510ooYKOF0qklAheAXFp0kYKUgokKspISBQ8AB1CFLmwya5m1h57PB5fx7OzP8fOrrQFEoz06dij49/n/MfVo8fPcPt7AWy3mOcZ28xufci0meGshQ0b2BFIM9D3PWTXgXGOBWnoYUD15OlzLJdLkCLGGJHGVGJO5FKACQHZK/y8WeH0/Bzvzz7h9ccf+PztChcXH3B8coSXr17g7bs3uPxyieru5hZCSPC2xf2qLqwZQ0OsGUcnJbRSUJ0EoxzBG7R8DdEycE45TQNOuYwQokWVq3HjhMFHaBegrS/Rh4QrzfBdcPySEQ31aeNUcjM2x5jg6XycJkw7KkEVWGMQQkDbShjywTuH4D2MMxC074xDbyycDxhTQiRyHMmeOI5lnXZULbXRkV+Rbrq7X0AqCU8HE92WB/VAHtTDsP71VXVdl/61HigqqtCSePivw38V5DRypXpYq1DXX8noFVWs4KjtPTY/FyKvszV7PNmSOdxX+bnkb7OZSPCaBNel2mEwVK2hOMCQx1prEnXFmj1FiLo5/PcHOqqoNozK9aoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"authorization\"\n        title=\"\"\n        src=\"/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/b9e4f/authorization.png\"\n        srcset=\"/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/cf440/authorization.png 148w,\n/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/d2d38/authorization.png 295w,\n/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/b9e4f/authorization.png 590w,\n/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/f9b6a/authorization.png 885w,\n/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/2d849/authorization.png 1180w,\n/tech-blog/static/c16e41e2ffeb67f2d100fb6bba285cab/c2216/authorization.png 1890w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>do you see the highlighted part? thats the JWT Token. every request includes that token. Without that token, that server will throw a 401 or 403 HTTP Error stating you do not have access to this resource.</p>\n<p>We need to incorporate that in our app.</p>\n<p>lets first setup our application. we will use that same Ionic and Node app from previous part.</p>\n<p>We need to add a check in our Node.js / Express app. That check will check if the request that Authorization token in it. If it doesnot, then it will throw an error.</p>\n<p>We use <em>middlewares</em> for that.</p>\n<p>The main idea of middlewares is that every request goes through middleware before executing our method.</p>\n<p>Lets see some code to get a better idea.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const checkAuth = require(&#39;../middleware/check-auth&#39;);\n\nrouter.get(&quot;/&quot;,checkAuth, bookController.getAll);</code></pre></div>\n<p>When we go to localhost:3000/books</p>\n<p>then first <code class=\"language-text\">checkAuth</code> will run. After that, <code class=\"language-text\">UserController.getAll</code> will run.</p>\n<p>If any error then checkAuth will throw the error and it won’t touch <code class=\"language-text\">UserController.getAll</code>. That’s it. that’s all the logic.</p>\n<p>lets also make one change in our code.</p>\n<p>in users.controller.js</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> const token = jsonwebtoken.sign({\n               data: result,\n               role: &#39;User&#39;\n            }, process.env.JWT_KEY, { expiresIn: &#39;7d&#39; });</code></pre></div>\n<p>make sure we use <code class=\"language-text\">process.env.JWT_KEY</code> instead of previously <code class=\"language-text\">supersecretToken</code></p>\n<p>Lets take a look at <code class=\"language-text\">checkAuth</code> middleware.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const jwt = require(&#39;jsonwebtoken&#39;);\n\nmodule.exports = (req, res, next) =&gt; {\n    try {\n        const token = req.headers.authorization;\n        const decoded = jwt.verify(token, process.env.JWT_KEY);\n        req.userData = decoded;\n        next();\n    } catch (error) {\n        next({\n            message: &#39;Auth failed&#39;,\n            status: 401\n        });\n    }\n};</code></pre></div>\n<p>we get that authorization from <code class=\"language-text\">req.headers</code>.</p>\n<p>we decode it using the jwt library.</p>\n<p>if there is no token or it has expired, then it will throw the error.</p>\n<p>Lets see this in action.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/e0124299570cadd27de6f76a09b41805/6095e/unauth.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 63.191153238546605%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABJ0AAASdAHeZh94AAAB/ElEQVQ4y42T227UMBCG83hcI5B4hD5PL7iDa3iRShQEt6inVZdt18kmseNTDk7889tZtaiAWkuf/sn4kBnPuHDOYRgGSKlQVgfUrUSnDazzxD3Bw3kHYw2cs/C0k1qriaHforA2OVbS4e5oG2My9qjZpr+RGveiQVl3ODQre6EgSgWtNYpxHPEcAwlhhNQDTj4EvD1dcPJxxrvTiNfvDV6dfcKbb59RM8pimiY8xziu6vsRPzYzzq8ivm8WfL2OOL8JONsLfBECru9fFuEjA4AF64hHHkdaU4QXRJgIIeQN8xLXo+If8HtelvXAtXIengVJ9LRzcf6JzZumdK/sjESKehj6/NO0t7jdCVRVg6pusd1L7O4EmqZl61gopaE6zerZ3Eptq3B3v+e8pN9Aqi7PS9lBm9ROjhG2P2HlDUx7BV1fQh0u0NUXcIq+5jL7k+pEe501zQ12i9Ht0JstfLfBaH8hThWKQdxCiS0OuxtUu2uouw081fK7rwVG3WLoKgRVYSZB15ikQJAlQiswNXv0tCeuW3yHIl2o63q0TFeWJXR5YJQ1JK+gY9NaxVfBtHqm3TPFwBaKqTBhZkRz1pmFp4BuFKncwQdGafh3g8VoLpw4yxVzyHaGVV4CdZ7x94gPuh44BnjJKisF1zAlPrMY40OnxSdb89x/+A2gt+Xq/p6UMQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"unauth\"\n        title=\"\"\n        src=\"/tech-blog/static/e0124299570cadd27de6f76a09b41805/b9e4f/unauth.png\"\n        srcset=\"/tech-blog/static/e0124299570cadd27de6f76a09b41805/cf440/unauth.png 148w,\n/tech-blog/static/e0124299570cadd27de6f76a09b41805/d2d38/unauth.png 295w,\n/tech-blog/static/e0124299570cadd27de6f76a09b41805/b9e4f/unauth.png 590w,\n/tech-blog/static/e0124299570cadd27de6f76a09b41805/f9b6a/unauth.png 885w,\n/tech-blog/static/e0124299570cadd27de6f76a09b41805/2d849/unauth.png 1180w,\n/tech-blog/static/e0124299570cadd27de6f76a09b41805/6095e/unauth.png 1266w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>we get a 401 error. We don’t see our books list anymore.</p>\n<p>For that to happen, we first need to save our JWT token after we login into local Storage or ionic Storage.</p>\n<p>lets do that.</p>\n<p>lets create an <code class=\"language-text\">auth.service.ts</code> file in sdk -> core folder.</p>\n<p>lets install these to access ionic storage.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ionic cordova plugin add cordova-sqlite-storage\n\nnpm install @ionic/storage</code></pre></div>\n<p>to use it in our service file, we need to import it in app.module.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">imports: [\n    BrowserModule,\n    IonicModule.forRoot(),\n    IonicStorageModule.forRoot(),\n    HttpClientModule,\n    AppRoutingModule\n  ]</code></pre></div>\n<p>lets write code in our Auth.service.ts file</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { Injectable } from &#39;@angular/core&#39;;\nimport { Storage } from &#39;@ionic/storage&#39;;\n\n@Injectable({\n  providedIn: &#39;root&#39;\n})\nexport class AuthService {\n  constructor(private storage: Storage) {}\n\n  public saveTokenToStorage(token: string) {\n    this.storage.set(&#39;token&#39;, token);\n  }\n\n  public async getTokenFromStorage() {\n    return await this.storage.get(&#39;token&#39;);\n  }\n}</code></pre></div>\n<p>we will use this in login.page.ts</p>\n<p>lets update our code. we just add one line. we get the token in data.token so</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  data =&gt; {\n        console.log(&#39;got response from server&#39;, data);\n        this.loading = false;\n        this.authService.saveTokenToStorage(data.token);\n        this.router.navigateByUrl(&#39;/home&#39;);\n      },</code></pre></div>\n<p>Nice. we still however need to add this token to our books request. Lets do that.</p>\n<p>We will be changing our methods a little bit.</p>\n<p>We first need to update our GET /books request.</p>\n<p>lets go to <code class=\"language-text\">books.service.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  public async getAllBooks(): Promise&lt;any&gt; {\n    const url = BookyConfig.getPath() + &#39;/books&#39;;\n    const token = await this.authService.getTokenFromStorage();\n    return this.http.get(url, {\n      headers: new HttpHeaders().set(&#39;Authorization&#39;, token)\n    });\n  }</code></pre></div>\n<p>Few things we changed. We converted our Observable to Promise (because we had to use async/await for getting token from Ionic Storage).</p>\n<p>we append that Token in our headers.</p>\n<p>remember our Node.js middleware where we read <code class=\"language-text\">req.headers.authorization</code> ? that’s what we are adding here.</p>\n<p>We also updated the component method. Lets take a look.</p>\n<p>books.page.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">async getAll() {\n    this.loading = true;\n\n    const observable = await this.booksService.getAllBooks();\n    observable.subscribe(\n      data =&gt; {\n        this.books = data.data.docs;\n        this.loading = false;\n        console.log(&#39;data&#39;, data);\n      },\n      err =&gt; {\n        console.log(&#39;err&#39;, err);\n      }\n    );\n  }</code></pre></div>\n<p>Now, our books should return.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/79c520a1eb7e063690c2a9a4b0077b1f/4221c/booksback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 453px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 106.18101545253865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABJ0AAASdAHeZh94AAADKUlEQVQ4y51TyU4UURTtlYlb49KNkmg0Mu1cudSdxpV/4AdgVIYwqGDCQuPCD3DhSmYQASMIkYAgUUIkjE0DPdPdRY81vKp6x3tfdWNDMCKvcurevFd13rmTb2bVREuXwIt+gfY+gQ7Csx6h9loJbd3eXnsZOvostA0n0TQcQ/NwHM0fY3g0sIeplRx8bydNXKoDapqAqkbgWj1wsx24/wa49xq41Qlcr/fOKhslqsm/8jSJc4t1uOp/goq1x6j1t+Ds8gN0bI4xoYGKOonaJhfVjS4qGyRutEncfSVx56XE7U6JKtqrZjI6r2mgS9s0nB9vxcXZVlyYbsHlmec4M/EQnctT8K3u6uidFxhZdDH808HggkD/d4Hub5ZC75yl9gYXSlZgiDAwb6BnLk//Fgh5vJ/RsbxdgM+1TfByzAy98vj3kkUcc+KY8Nm2g51QFO96BtE1NIb9TA6b/gBW1zawur4B/9Y2QuEoNja3kEhqcInLdiT42ctI5AwJf1wiTnqERYTCspDJ5rAbjiBI0A0DQgjouo5CoaCsaZrKt23bUyI9hcKBusAQErYLWPSdzyCCky4mcl33AFJ6AIMUM5ePWQXdvBnYUSr5J4tUs2VFDPaPgglcsg5JFI5USjkSn+s42A2F0fNhBIOjnymHGYSCQSwtLSEQCGBlZQXpdPpQqEWDRJbDBbb2pPIdQYSsxiDmlLYPbT+t1PLyQpIHRH+DqnjxO/N/c1i+1IVFHMohV7lAlZxd+IHFX8sqZ7lcDvl8HhkKn202mz3wPVtQqiwKRhCy1DomWYvbxlE5jGBkfBKfJr9iP51BPB5DKBRCJBLB+vo6gpTTWCymrN/vp7MwibKh0RxYtkQwJaHRHTbnkONm+aqiRM7+SVuIw/RsWcilHJYKcPIclhfE+1cRsjKu8OjEFL5Mz8KiKUkmkwqpVIrCjyORSEDTNNVG0WgUJRF5k3JHbcMjmDWKo8eE0fieKgojTyPGiWciJg2Hwwrsc07Z13WPMKNT8zvcjzTTZpHwNG0j1YR47aLapjyHXBR5TPOWGvvP3B72D39b1tj8OjoNp1FcIvwNYtsZHqWmKvoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"booksback\"\n        title=\"\"\n        src=\"/tech-blog/static/79c520a1eb7e063690c2a9a4b0077b1f/4221c/booksback.png\"\n        srcset=\"/tech-blog/static/79c520a1eb7e063690c2a9a4b0077b1f/cf440/booksback.png 148w,\n/tech-blog/static/79c520a1eb7e063690c2a9a4b0077b1f/d2d38/booksback.png 295w,\n/tech-blog/static/79c520a1eb7e063690c2a9a4b0077b1f/4221c/booksback.png 453w\"\n        sizes=\"(max-width: 453px) 100vw, 453px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Now, unless you login properly, the GET request won’t work.</p>\n<p>we need to add this to other methods as well in Node.js server.</p>\n<p><code class=\"language-text\">books.routes.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const checkAuth = require(&#39;../middleware/check-auth&#39;);\n\nconst bookController = require(&#39;../controllers/books.controllers&#39;);\n\nrouter.get(&quot;/&quot;,checkAuth,bookController.getAll);\nrouter.post(&quot;/add&quot;,checkAuth,bookController.addBook);\nrouter.put(&quot;/:_id&quot;,checkAuth, bookController.updateBook);\nrouter.delete(&quot;/:_id&quot;,checkAuth, bookController.deleteBook);</code></pre></div>\n<p>Now it will work for all.</p>\n<p>we need to update our methods in Angular/Ionic as well.</p>\n<p>books.service.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { HttpClient, HttpHeaders } from &#39;@angular/common/http&#39;;\n\nimport { AuthService } from &#39;./../core/auth.service&#39;;\nimport { BookyConfig } from &#39;../booky.config&#39;;\nimport { Injectable } from &#39;@angular/core&#39;;\n\n@Injectable({\n  providedIn: &#39;root&#39;\n})\nexport class BooksService {\n  constructor(private http: HttpClient, private authService: AuthService) {}\n\n  public async getAllBooks(): Promise&lt;any&gt; {\n    const url = BookyConfig.getPath() + &#39;/books&#39;;\n    const token = await this.authService.getTokenFromStorage();\n    return this.http.get(url, {\n      headers: new HttpHeaders().set(&#39;Authorization&#39;, token)\n    });\n  }\n\n  public async addNewBook(data: object): Promise&lt;any&gt; {\n    const url = BookyConfig.getPath() + &#39;/books/add&#39;;\n    const token = await this.authService.getTokenFromStorage();\n\n    return this.http.post(url, data, {\n      headers: new HttpHeaders().set(&#39;Authorization&#39;, token)\n    });\n  }\n  public async updateBook(data): Promise&lt;any&gt; {\n    const url = BookyConfig.getPath() + `/books/${data._id}`;\n    const token = await this.authService.getTokenFromStorage();\n\n    return this.http.put(url, data, {\n      headers: new HttpHeaders().set(&#39;Authorization&#39;, token)\n    });\n  }\n  public async deleteBook(id: string): Promise&lt;any&gt; {\n    const url = BookyConfig.getPath() + `/books/${id}`;\n    const token = await this.authService.getTokenFromStorage();\n\n    return this.http.delete(url, {\n      headers: new HttpHeaders().set(&#39;Authorization&#39;, token)\n    });\n  }\n}</code></pre></div>\n<p>Lets update the methods as well</p>\n<p>books.page.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  async deleteBook() {\n    this.deleteLoading = true;\n    const observable = await this.booksService.deleteBook(\n      this.selectedBook._id\n    );\n\n    observable.subscribe(\n      data =&gt; {\n        console.log(&#39;got response from server&#39;, data);\n        this.deleteLoading = false;\n        this.getAll();\n      },\n      error =&gt; {\n        this.deleteLoading = false;\n        console.log(&#39;error&#39;, error);\n      }\n    );\n  }\n  }</code></pre></div>\n<p>addnewbook.component.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  async addNew() {\n    const observable = await this.booksService.addNewBook(\n      this.addNewBookForm.value\n    );\n    observable.subscribe(\n      async data =&gt; {\n        console.log(&#39;got response from server&#39;, data);\n        const name = this.addNewBookForm.controls[&#39;name&#39;].value;\n        const toast = await this.toastController.create({\n          message: `${name} has been added successfully.`,\n          duration: 3500\n        });\n        toast.present();\n        this.loading = false;\n        this.addNewBookForm.reset();\n        //optional\n\n        this.modalCtrl.dismiss();\n      },\n      error =&gt; {\n        this.loading = false;\n        console.log(&#39;error&#39;, error);\n      }\n    );\n  }\n  async updateBook() {\n    const observable = await this.booksService.updateBook(\n      this.addNewBookForm.value\n    );\n\n    observable.subscribe(\n      async data =&gt; {\n        console.log(&#39;got response from server&#39;, data);\n        const name = this.addNewBookForm.controls[&#39;name&#39;].value;\n        const toast = await this.toastController.create({\n          message: `${name} has been updated successfully.`,\n          duration: 3500\n        });\n        toast.present();\n        this.loading = false;\n        this.addNewBookForm.reset();\n        //optional\n\n        this.modalCtrl.dismiss();\n      },\n      error =&gt; {\n        this.loading = false;\n        console.log(&#39;error&#39;, error);\n      }\n    );\n  }</code></pre></div>\n<p>Now our flow is working.</p>\n<p>Now we’re successfully restricting our user access to the API without our secure token.</p>\n<p>What we need to do is prevent the user even going to books page if he doesnot have a token.</p>\n<p>In Angular, we do that using <strong><em>Guards</em></strong></p>\n<p>Lets create a folder inside sdk -> custom -> guards</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/3983283215db8b77e9ecbd51ea6cbf54/f00c5/newfiles.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 323px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 77.70897832817337%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABJ0AAASdAHeZh94AAACrUlEQVQ4y4VUy3KbQBDkB3LKLYks81xeywLL8hJCAuvlqOy4UuVrbr7lD/IHued7O8NadjllKz4MDAvb09vTg+H4CbxAoN/doFrtUJcSdaVwYQUw3ejdmNsh7edIRKZzw2YcLoF2myPqbo1KpiilxMz09YZLJ9RxDnB657AYYZTo3JguLEph+hnM+99gzQZeIxHUJeYvWJ4DvSRWVpjAzXKdG9Oi4xPLIEXcfAUTCm4i4PIU1jtgT+8sYujQsTVD0yUNohwJAfy5XWBQCn1b4jAscNXVsL3XgC+fJ90YMczTk4YWbbC8mHQUEFUBObZgsYBPHwSFhH2qfA5QM/SJIe2xCcOYwCbQMCoQrCQOD3cIFy3idQM+dnT8FBdzX+s5N4N/dH0CnIp61GU3yB411CxZhIuZD7dPwNoULJdgSsInG3l5DlZOjSrAiLXuvHsKmwpMDKmw46cwHKLpkg9ZnMFyOOKrAj51OaxqiE0P3rfgqw58SawXDa2X9F38GC4njamh5BI/p2J0SoPnC0yRqiUdu4W465Edeshhg+rmAHXYQV3vUR73KLZbqP1O5/W3a+TrEbFokJRLZP0AIVcw/JgYcUKneyIkmpG0LBQiRRo2LcKyQVw1EMsOUd0ime70HNfEVlbwwhxBosCLGiGBP2v4aR5i7AM83DMaP7INNWW7atBR58eupKgwUAgu8GXOdHMm/WaWDy5SjMsapnfqsk0xsyKUZYzbPfkyzJDmxFLkEJlCQjnPCoQ80748Z3KX2Gof2uT0z5chhtLEjzuHNF2iH7aQdY9utUHTX6FdjkhlTT+N1zP+2PVnwBjmtMAEPnz/BUttkWYlZNUhSYllUkA1PXK1gB/TvDrBm+NnvgX48fiTvDZi0Q2aWdePKNsVuvUW4+4Ikdc0Xv8H/Aswp+qHLOvdHAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"newfiles\"\n        title=\"\"\n        src=\"/tech-blog/static/3983283215db8b77e9ecbd51ea6cbf54/f00c5/newfiles.png\"\n        srcset=\"/tech-blog/static/3983283215db8b77e9ecbd51ea6cbf54/cf440/newfiles.png 148w,\n/tech-blog/static/3983283215db8b77e9ecbd51ea6cbf54/d2d38/newfiles.png 295w,\n/tech-blog/static/3983283215db8b77e9ecbd51ea6cbf54/f00c5/newfiles.png 323w\"\n        sizes=\"(max-width: 323px) 100vw, 323px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>we create two files.</p>\n<p>islogin.guard.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { CanActivate, Router } from &#39;@angular/router&#39;;\n\nimport { AuthService } from &#39;src/sdk/core/auth.service&#39;;\nimport { Injectable } from &#39;@angular/core&#39;;\n\n@Injectable({\n  providedIn: &#39;root&#39;\n})\nexport class IsLoginGuard implements CanActivate {\n  constructor(private router: Router, private authService: AuthService) {}\n\n  async canActivate() {\n    const token = await this.authService.getTokenFromStorage();\n    if (!token) {\n      this.router.navigateByUrl(&#39;/login&#39;);\n    } else {\n      return true;\n    }\n  }\n}</code></pre></div>\n<p>we will come back to redirect.login.ts in a while.</p>\n<p>In the meantime, lets use <code class=\"language-text\">IsLoginGuard</code> service/guard we created.</p>\n<p>lets go to app-routing.module.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> {\n    path: &#39;books&#39;,\n    canActivate: [IsLoginGuard],\n    loadChildren: () =&gt;\n      import(&#39;./books/books.module&#39;).then(m =&gt; m.BooksPageModule)\n  }</code></pre></div>\n<p>Now if there is no token, it won’t let us go to books page.</p>\n<p>To test it, lets change app.component.html and .ts a little bit</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  &lt;ion-list&gt;\n          &lt;ion-menu-toggle auto-hide=&quot;false&quot; *ngFor=&quot;let p of appPages&quot;&gt;\n            &lt;ion-item *ngIf=&quot;p?.title!==&#39;Logout&#39;&quot; [routerDirection]=&quot;&#39;root&#39;&quot; [routerLink]=&quot;[p.url]&quot;&gt;\n              &lt;ion-icon *ngIf=&quot;p?.icon&quot; slot=&quot;start&quot; [name]=&quot;p.icon&quot;&gt;&lt;/ion-icon&gt;\n              &lt;ion-label&gt;\n                {{p.title}}\n              &lt;/ion-label&gt;\n            &lt;/ion-item&gt;\n            &lt;ion-item (click)=&quot;logout()&quot; *ngIf=&quot;p?.title===&#39;Logout&#39;&quot;&gt;\n              &lt;ion-icon *ngIf=&quot;p?.icon&quot; slot=&quot;start&quot; [name]=&quot;p.icon&quot;&gt;&lt;/ion-icon&gt;\n              &lt;ion-label&gt;\n                {{p.title}}\n              &lt;/ion-label&gt;\n            &lt;/ion-item&gt;\n          &lt;/ion-menu-toggle&gt;\n        &lt;/ion-list&gt;</code></pre></div>\n<p>app.component.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public appPages = [\n    {\n      title: &#39;Home&#39;,\n      url: &#39;/home&#39;,\n      icon: &#39;home&#39;\n    },\n    {\n      title: &#39;Books&#39;,\n      url: &#39;/books&#39;,\n      icon: &#39;book&#39;\n    },\n    {\n      title: &#39;Logout&#39;,\n      icon: &#39;power&#39;\n    }\n  ];\n\n  logout() {\n    this.authService.logout();\n  }</code></pre></div>\n<p>Click on logout on the drawer will log you out of the app (It will delete the token from storage).</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/tech-blog/static/2a36a8632891237871053554071845fc/a987b/tokensaved.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 43.541666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABJ0AAASdAHeZh94AAABFElEQVQoz6WSy07DMBBF/f+fwF8g0Q1iAcuKTSuxYxvlZcdvp3lfxm6CAuqGMtKRx+OZa49t1vc9fjMMQxq998kHFihpcD59YJom3KrZYLFgz14whICu6xAtzwQOj2/kzRS7IbbWs2ugS4WRvXCct21IgpJ/4vj6gHkBhnHAOI4/2OqYUgrGmITWGmVRIC9K5BVHXJNSprjgNa1l0BTjVYWG8yuCqGuIqoAQAqxpJKx1sM5BUnKR53RfEkqb740i1lrK8ZAkoEhIxZEEkr9iKY9pKdB6i0vr4KxK9/YfY4djhqf3Es8niZdzA0GvGW2eZyzL8mdYKQyqxiZKrnFZX/XuEypqOVDLwTv6dxYttbx9nXv4AjvcuN7yZJINAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"token saved\"\n        title=\"\"\n        src=\"/tech-blog/static/2a36a8632891237871053554071845fc/b9e4f/tokensaved.png\"\n        srcset=\"/tech-blog/static/2a36a8632891237871053554071845fc/cf440/tokensaved.png 148w,\n/tech-blog/static/2a36a8632891237871053554071845fc/d2d38/tokensaved.png 295w,\n/tech-blog/static/2a36a8632891237871053554071845fc/b9e4f/tokensaved.png 590w,\n/tech-blog/static/2a36a8632891237871053554071845fc/f9b6a/tokensaved.png 885w,\n/tech-blog/static/2a36a8632891237871053554071845fc/2d849/tokensaved.png 1180w,\n/tech-blog/static/2a36a8632891237871053554071845fc/a987b/tokensaved.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>We can see our token being saved in IndexedDB (Ionic Storage handles this for us).</p>\n<p>Lets see what redirectLogin is supposed to do.</p>\n<p>Imagine if Im already logged in, I should never go to login page right? right now I can do that. which is wrong.</p>\n<p>so lets add redirectLogin.guard.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { CanActivate, Router } from &#39;@angular/router&#39;;\n\nimport { AuthService } from &#39;src/sdk/core/auth.service&#39;;\nimport { Injectable } from &#39;@angular/core&#39;;\n\n@Injectable({\n  providedIn: &#39;root&#39;\n})\nexport class RedirectLoginGuard implements CanActivate {\n  constructor(private router: Router, private authService: AuthService) {}\n\n  async canActivate() {\n    const token = await this.authService.getTokenFromStorage();\n    if (token) {\n      this.router.navigateByUrl(&#39;/books&#39;);\n    } else {\n      return true;\n    }\n  }\n}</code></pre></div>\n<p>lets use it in app-routing.module.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  {\n    path: &#39;login&#39;,\n    canActivate: [RedirectLoginGuard],\n    loadChildren: () =&gt;\n      import(&#39;./login/login.module&#39;).then(m =&gt; m.LoginPageModule)\n  },\n  {\n    path: &#39;register&#39;,\n    canActivate: [RedirectLoginGuard],\n    loadChildren: () =&gt;\n      import(&#39;./register/register.module&#39;).then(m =&gt; m.RegisterPageModule)\n  },</code></pre></div>\n<p>Now if I go to login page, it takes me to /books as long as I’m logged in.</p>\n<p>We have covered almost all scenarios. However, one is missing.</p>\n<p>Lets say your token has expired and server send a 401 error. What do you do now? if we get a 401 or 403 error from server, we need to quickly send it back to login page. don’t allow access to Books api.</p>\n<p>For that, we use <em>Interceptors</em></p>\n<p>Interceptors in Angular catch requests before and after. All HTTP Requests in Angular go through the interceptor.</p>\n<p>lets create an httpinterceptor.service.ts in sdk -> core -> httpinterceptor.service.ts</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import {\n  HTTP_INTERCEPTORS,\n  HttpErrorResponse,\n  HttpEvent,\n  HttpHandler,\n  HttpInterceptor,\n  HttpRequest\n} from &#39;@angular/common/http&#39;;\n\nimport { AuthService } from &#39;./auth.service&#39;;\nimport { Injectable } from &#39;@angular/core&#39;;\nimport { Observable } from &#39;rxjs/internal/Observable&#39;;\nimport { Router } from &#39;@angular/router&#39;;\nimport { tap } from &#39;rxjs/operators&#39;;\n\n@Injectable()\nexport class ErrorInterceptor implements HttpInterceptor {\n  constructor(private router: Router, private authService: AuthService) {}\n\n  intercept(\n    req: HttpRequest&lt;any&gt;,\n    next: HttpHandler\n  ): Observable&lt;HttpEvent&lt;any&gt;&gt; {\n    return next.handle(req).pipe(\n      tap(\n        event =&gt; {},\n        err =&gt; {\n          if (\n            err instanceof HttpErrorResponse &amp;&amp;\n            (err.status === 403 || err.status === 401)\n          ) {\n            this.authService.logout();\n          }\n        }\n      )\n    );\n  }\n}</code></pre></div>\n<p>To use it, lets go to app.module.ts</p>\n<p>import these</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { HTTP_INTERCEPTORS, HttpClientModule } from &#39;@angular/common/http&#39;;\n\nimport { ErrorInterceptor } from &#39;src/sdk/core/httpinterceptor.service&#39;;</code></pre></div>\n<p>and update providers</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">providers: [\n    StatusBar,\n    SplashScreen,\n    {\n      provide: HTTP_INTERCEPTORS,\n      useClass: ErrorInterceptor,\n      multi: true\n    },\n    { provide: RouteReuseStrategy, useClass: IonicRouteStrategy }\n  ],</code></pre></div>\n<p>and Boom. its set up.</p>\n<p>We covered quite a few things things here</p>\n<h3>Authentication</h3>\n<p>Check if the user is login or not.</p>\n<h3>Authorization</h3>\n<p>Check if the user has to roles to perform certain tasks. For e.g is it admin or user ? We didn’t cover this in here.</p>\n<h3>Guards</h3>\n<p>Angular services that prevent going to a page/route under some condition.</p>\n<h3>Interceptor</h3>\n<p>Catch HTTP Requests and give us control. These are like middlewares for angular.</p>\n<p>Here’s <a href=\"https://github.com/alamgirqazi/intro-to-nodejs-part7\">link</a> to the node.js app code.</p>\n<p>Here’s <a href=\"https://github.com/alamgirqazi/booky-ionic/tree/part7\">link</a> to the ionic app code. (<em>branch part7</em>)</p>\n<p>In the next part, we will deploy our application to production.</p>\n<p>we will use mlab / mongodb Atlas for online database.</p>\n<p>we will use heroku platform to deploy our backend.</p>\n<p>we will create an APK app using Capacitor.</p>","frontmatter":{"title":"A very basic introduction to Node.js - Part 7","date":"December 15, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/intro-to-nodejs-part-7/","previous":{"fields":{"slug":"/intro-to-nodejs-part-6/"},"frontmatter":{"title":"A very basic introduction to Node.js - Part 6"}},"next":null}}}